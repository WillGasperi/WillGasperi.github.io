<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <!-- Google AdSense -->
    <script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-8722541060502556"
     crossorigin="anonymous"></script>
    <meta name="google-adsense-account" content="ca-pub-8722541060502556">

    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Cambori√∫ 3D - Calculadora de Or√ßamento</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap');
        
        body {
            font-family: 'Poppins', sans-serif;
            background-color: #f0f4f8;
        }
        
        .input-group {
            transition: all 0.3s ease;
        }
        
        .input-group:hover {
            transform: translateY(-2px);
        }
        
        input[type="number"]::-webkit-inner-spin-button,
        input[type="number"]::-webkit-outer-spin-button {
            -webkit-appearance: none;
            margin: 0;
        }
        
        .result-card {
            transition: all 0.3s ease;
        }
        
        .result-card:hover {
            transform: scale(1.02);
        }
        
        .tab {
            transition: all 0.3s ease;
        }
        
        .tab.active {
            border-bottom: 3px solid #4f46e5;
            color: #4f46e5;
        }
        
        .tab:hover:not(.active) {
            border-bottom: 3px solid #818cf8;
            color: #818cf8;
        }
        
        .custom-scrollbar::-webkit-scrollbar {
            width: 6px;
        }
        
        .custom-scrollbar::-webkit-scrollbar-track {
            background: #f1f1f1;
        }
        
        .custom-scrollbar::-webkit-scrollbar-thumb {
            background: #888;
            border-radius: 3px;
        }
        
        .custom-scrollbar::-webkit-scrollbar-thumb:hover {
            background: #555;
        }
        
        .tooltip {
            position: relative;
            display: inline-block;
        }

        .tooltip .tooltiptext {
            visibility: hidden;
            width: 220px;
            background-color: #333;
            color: #fff;
            text-align: center;
            border-radius: 6px;
            padding: 8px;
            position: absolute;
            z-index: 1;
            bottom: 125%;
            left: 50%;
            margin-left: -110px;
            opacity: 0;
            transition: opacity 0.3s;
            font-size: 12px;
        }

        .tooltip:hover .tooltiptext {
            visibility: visible;
            opacity: 1;
        }
        
        .card-section {
            background: white;
            border-radius: 0.5rem;
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1);
            padding: 1.5rem;
            margin-bottom: 1.5rem;
        }
        
        .card-title {
            font-size: 1.25rem;
            font-weight: 600;
            color: #1f2937;
            margin-bottom: 1rem;
            border-bottom: 1px solid #e5e7eb;
            padding-bottom: 0.5rem;
        }
        
        .input-label {
            display: block;
            font-size: 0.875rem;
            font-weight: 500;
            color: #374151;
            margin-bottom: 0.25rem;
        }
        
        .input-field {
            width: 100%;
            padding: 0.5rem 1rem;
            border: 1px solid #d1d5db;
            border-radius: 0.375rem;
            outline: none;
            transition: all 0.2s;
        }
        
        .input-field:focus {
            border-color: #4f46e5;
            box-shadow: 0 0 0 3px rgba(79, 70, 229, 0.1);
        }
        
        .btn-primary {
            background-color: #4f46e5;
            color: white;
            font-weight: 500;
            padding: 0.75rem 1.5rem;
            border-radius: 0.375rem;
            transition: all 0.3s;
        }
        
        .btn-primary:hover {
            background-color: #4338ca;
            transform: scale(1.02);
        }
        
        .btn-secondary {
            background-color: white;
            color: #4f46e5;
            font-weight: 500;
            padding: 0.5rem 1rem;
            border-radius: 0.375rem;
            transition: all 0.3s;
        }
        
        .btn-secondary:hover {
            background-color: #eef2ff;
        }
        
        .cost-row {
            display: flex;
            justify-content: space-between;
            font-size: 0.875rem;
            padding: 0.25rem 0;
        }
        
        .printer-option {
            border: 2px solid #e5e7eb;
            border-radius: 0.5rem;
            padding: 0.75rem;
            cursor: pointer;
            transition: all 0.2s;
        }
        
        .printer-option:hover {
            border-color: #a5b4fc;
        }
        
        .printer-option.selected {
            border-color: #4f46e5;
            background-color: #eef2ff;
        }
        
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        .animate-fade {
            animation: fadeIn 0.3s ease-out;
        }
        
        .subtab {
            transition: all 0.3s ease;
            color: #6b7280;
        }
        
        .subtab.active {
            border-color: #4f46e5;
            color: #4f46e5;
            background-color: #eef2ff;
        }
        
        .subtab:hover:not(.active) {
            background-color: #f9fafb;
        }
    </style>
</head>
<body>
    <div class="min-h-screen py-4 px-4 sm:px-6 lg:px-8">
        <div class="max-w-7xl mx-auto">
            
            <!-- Header -->
            <div class="bg-gradient-to-r from-indigo-600 to-purple-600 rounded-lg shadow-lg p-6 mb-6">
                <div class="flex flex-col md:flex-row justify-between items-center">
                    <div>
                        <h1 class="text-3xl font-bold text-white">Cambori√∫ 3D</h1>
                        <p class="text-indigo-100 mt-1">Calculadora Profissional de Or√ßamentos</p>
                    </div>
                    <div class="mt-4 md:mt-0 flex gap-2">
                        <button onclick="limparFormulario()" class="btn-secondary">
                            üîÑ Novo
                        </button>
                        <button onclick="exportarPDF()" class="bg-indigo-800 hover:bg-indigo-900 text-white font-medium py-2 px-4 rounded-md transition duration-300">
                            üìÑ Exportar PDF
                        </button>
                    </div>
                </div>
            </div>
            
            <!-- Tabs -->
            <div class="bg-white rounded-lg shadow-md mb-6">
                <div class="flex overflow-x-auto">
                    <button class="tab active flex-1 py-4 px-6 text-center font-medium" data-tab="calculadora" onclick="mudarTab('calculadora')">
                        üßÆ Calculadora
                    </button>
                    <button class="tab flex-1 py-4 px-6 text-center font-medium" data-tab="impressoras" onclick="mudarTab('impressoras')">
                        üñ®Ô∏è Impressoras
                    </button>
                    <button class="tab flex-1 py-4 px-6 text-center font-medium" data-tab="filamentos" onclick="mudarTab('filamentos')">
                        üßµ Filamentos
                    </button>
                    <button class="tab flex-1 py-4 px-6 text-center font-medium" data-tab="configuracoes" onclick="mudarTab('configuracoes')">
                        ‚öôÔ∏è Configura√ß√µes
                    </button>
                    <button class="tab flex-1 py-4 px-6 text-center font-medium" data-tab="historico" onclick="mudarTab('historico')">
                        üìã Hist√≥rico
                    </button>
                </div>
            </div>
            
            <!-- ==================== ABA CALCULADORA ==================== -->
            <div id="calculadoraTab" class="tab-content animate-fade">
                <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
                    
                    <!-- Coluna Esquerda: Formul√°rio -->
                    <div class="lg:col-span-2 space-y-6">
                        
                        <!-- Card: Dados do Projeto -->
                        <div class="card-section">
                            <h2 class="card-title">üì¶ Dados do Projeto</h2>
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                <div class="input-group">
                                    <label class="input-label">Nome da Pe√ßa</label>
                                    <input type="text" id="nomePeca" class="input-field" placeholder="Ex: Vaso Decorativo">
                                </div>
                                <div class="input-group">
                                    <label class="input-label">Cliente</label>
                                    <input type="text" id="clientePeca" class="input-field" placeholder="Ex: Jo√£o Silva">
                                </div>
                            </div>
                        </div>
                        
                        <!-- Card: Impressora -->
                        <div class="card-section">
                            <h2 class="card-title">üñ®Ô∏è Impressora</h2>
                            <div id="impressoraSelect" class="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 gap-3">
                                <!-- Impressoras carregadas via JS -->
                            </div>
                            <p id="semImpressoraMsg" class="text-gray-500 text-center py-4 hidden">
                                Nenhuma impressora cadastrada. 
                                <a href="#" onclick="mudarTab('impressoras')" class="text-indigo-600 hover:underline">Cadastre uma</a>
                            </p>
                        </div>
                        
                        <!-- Card: Material e Tempo -->
                        <div class="card-section">
                            <h2 class="card-title">üßµ Material e Tempo</h2>
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                <div class="input-group">
                                    <label class="input-label">
                                        Peso da Pe√ßa (gramas)
                                        <span class="tooltip ml-1 text-gray-400 cursor-help">
                                            ‚ÑπÔ∏è
                                            <span class="tooltiptext">Peso informado pelo fatiador (Cura, PrusaSlicer, etc)</span>
                                        </span>
                                    </label>
                                    <input type="number" id="pesoPeca" class="input-field" placeholder="Ex: 50" min="0" step="0.1" oninput="calcular()">
                                </div>
                                <div class="input-group">
                                    <label class="input-label">
                                        Filamento
                                        <span class="tooltip ml-1 text-gray-400 cursor-help">
                                            ‚ÑπÔ∏è
                                            <span class="tooltiptext">Selecione o filamento cadastrado ou cadastre um novo na aba Filamentos</span>
                                        </span>
                                    </label>
                                    <select id="filamentoSelect" class="input-field" onchange="selecionarFilamento()">
                                        <option value="">Selecione um filamento</option>
                                    </select>
                                    <p id="semFilamentoMsg" class="text-xs text-orange-500 mt-1 hidden">
                                        Nenhum filamento cadastrado. <a href="#" onclick="mudarTab('filamentos')" class="text-indigo-600 hover:underline">Cadastre um</a>
                                    </p>
                                </div>
                                <div class="input-group">
                                    <label class="input-label">Tempo de Impress√£o (horas)</label>
                                    <input type="number" id="tempoHoras" class="input-field" placeholder="Ex: 5" min="0" step="0.1" oninput="calcular()">
                                </div>
                                <div class="input-group">
                                    <label class="input-label">Tempo de Impress√£o (minutos)</label>
                                    <input type="number" id="tempoMinutos" class="input-field" placeholder="Ex: 30" min="0" max="59" oninput="calcular()">
                                </div>
                            </div>
                        </div>
                        
                        <!-- Card: Custos Extras -->
                        <div class="card-section">
                            <h2 class="card-title">üé® Custos Extras (Opcional)</h2>
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                <div class="input-group">
                                    <label class="input-label">
                                        Pintura / Acabamento (R$)
                                        <span class="tooltip ml-1 text-gray-400 cursor-help">
                                            ‚ÑπÔ∏è
                                            <span class="tooltiptext">Valor fixo cobrado pela pintura ou acabamento especial</span>
                                        </span>
                                    </label>
                                    <input type="number" id="valorPintura" class="input-field" placeholder="Ex: 50.00" min="0" step="0.01" oninput="calcular()">
                                </div>
                                <div class="input-group">
                                    <label class="input-label">
                                        Outros Custos (R$)
                                        <span class="tooltip ml-1 text-gray-400 cursor-help">
                                            ‚ÑπÔ∏è
                                            <span class="tooltiptext">Embalagem especial, parafusos, insertos, etc</span>
                                        </span>
                                    </label>
                                    <input type="number" id="outrosCustos" class="input-field" placeholder="Ex: 10.00" min="0" step="0.01" oninput="calcular()">
                                </div>
                            </div>
                        </div>
                        
                    </div>
                    
                    <!-- Coluna Direita: Resultado -->
                    <div class="lg:col-span-1">
                        <div class="card-section sticky top-4">
                            <h2 class="card-title">üí∞ Resultado do Or√ßamento</h2>
                            
                            <!-- Detalhamento -->
                            <div class="mb-4">
                                <h3 class="font-medium text-gray-700 mb-2">Custos de Produ√ß√£o</h3>
                                <div class="space-y-1 text-sm">
                                    <div class="cost-row">
                                        <span class="text-gray-600">üßµ Material (filamento)</span>
                                        <span class="font-medium" id="custoMaterial">R$ 0,00</span>
                                    </div>
                                    <div class="cost-row">
                                        <span class="text-gray-600">‚ö° Energia el√©trica</span>
                                        <span class="font-medium" id="custoEnergia">R$ 0,00</span>
                                    </div>
                                    <div class="cost-row">
                                        <span class="text-gray-600">üìâ Deprecia√ß√£o da m√°quina</span>
                                        <span class="font-medium" id="custoDepreciacao">R$ 0,00</span>
                                    </div>
                                    <div class="cost-row">
                                        <span class="text-gray-600">üîß Manuten√ß√£o</span>
                                        <span class="font-medium" id="custoManutencao">R$ 0,00</span>
                                    </div>
                                    <div class="cost-row">
                                        <span class="text-gray-600">üë∑ M√£o de obra</span>
                                        <span class="font-medium" id="custoMaoObra">R$ 0,00</span>
                                    </div>
                                    <div class="cost-row" id="rowPintura" style="display: none;">
                                        <span class="text-gray-600">üé® Pintura / Acabamento</span>
                                        <span class="font-medium" id="custoPintura">R$ 0,00</span>
                                    </div>
                                    <div class="cost-row" id="rowOutros" style="display: none;">
                                        <span class="text-gray-600">üì¶ Outros custos</span>
                                        <span class="font-medium" id="custoOutros">R$ 0,00</span>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- Custo Total -->
                            <div class="bg-gray-100 rounded-lg p-3 mb-4">
                                <div class="flex justify-between items-center">
                                    <span class="font-medium text-gray-700">Custo Total:</span>
                                    <span class="text-xl font-bold text-gray-800" id="custoTotal">R$ 0,00</span>
                                </div>
                            </div>
                            
                            <!-- Markup -->
                            <div class="mb-4">
                                <label class="input-label">
                                    Markup (sua margem de lucro) %
                                    <span class="tooltip ml-1 text-gray-400 cursor-help">
                                        ‚ÑπÔ∏è
                                        <span class="tooltiptext">Porcentagem de lucro sobre o custo. Ex: 50% = voc√™ ganha metade do custo como lucro.</span>
                                    </span>
                                </label>
                                <input type="number" id="markup" class="input-field" value="50" min="0" step="1" oninput="calcular()">
                            </div>
                            
                            <!-- Lucro -->
                            <div class="bg-green-50 border border-green-200 rounded-lg p-3 mb-4">
                                <div class="flex justify-between items-center">
                                    <span class="font-medium text-green-700">Seu Lucro:</span>
                                    <span class="text-xl font-bold text-green-600" id="valorLucro">R$ 0,00</span>
                                </div>
                            </div>
                            
                            <!-- Pre√ßo Final -->
                            <div class="bg-gradient-to-r from-indigo-500 to-purple-600 rounded-lg p-4 mb-4 text-white">
                                <div class="text-center">
                                    <p class="text-indigo-100 text-sm">Pre√ßo Final para o Cliente</p>
                                    <p class="text-3xl font-bold" id="precoFinal">R$ 0,00</p>
                                </div>
                            </div>
                            
                            <!-- Bot√µes -->
                            <div class="flex gap-2">
                                <button onclick="salvarOrcamento()" class="btn-primary flex-1">
                                    üíæ Salvar
                                </button>
                                <button onclick="copiarOrcamento()" class="bg-gray-200 hover:bg-gray-300 text-gray-700 font-medium py-3 px-4 rounded-md transition">
                                    üìã
                                </button>
                            </div>
                            
                        </div>
                    </div>
                    
                </div>
            </div>
            
            <!-- ==================== ABA IMPRESSORAS ==================== -->
            <div id="impressorasTab" class="tab-content hidden animate-fade">
                <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
                    
                    <!-- Formul√°rio de Cadastro -->
                    <div class="lg:col-span-1">
                        <div class="card-section sticky top-4">
                            <h2 class="card-title">‚ûï Cadastrar Impressora</h2>
                            <div class="space-y-4">
                                <div class="input-group">
                                    <label class="input-label">Nome da Impressora</label>
                                    <input type="text" id="nomeImpressora" class="input-field" placeholder="Ex: Ender 3 V2">
                                </div>
                                <div class="input-group">
                                    <label class="input-label">Valor Pago (R$)</label>
                                    <input type="number" id="valorImpressora" class="input-field" placeholder="Ex: 1500.00" min="0" step="0.01">
                                </div>
                                <div class="input-group">
                                    <label class="input-label">
                                        Vida √ötil (horas)
                                        <span class="tooltip ml-1 text-gray-400 cursor-help">
                                            ‚ÑπÔ∏è
                                            <span class="tooltiptext">Tempo estimado de funcionamento. Geralmente 3.000 a 10.000 horas</span>
                                        </span>
                                    </label>
                                    <input type="number" id="vidaUtilImpressora" class="input-field" placeholder="Ex: 5000" min="1" value="5000">
                                </div>
                                <div class="input-group">
                                    <label class="input-label">
                                        Pot√™ncia (Watts)
                                        <span class="tooltip ml-1 text-gray-400 cursor-help">
                                            ‚ÑπÔ∏è
                                            <span class="tooltiptext">Consumo m√©dio em Watts. Verifique na fonte ou manual (geralmente 200-500W)</span>
                                        </span>
                                    </label>
                                    <input type="number" id="potenciaImpressora" class="input-field" placeholder="Ex: 350" min="0">
                                </div>
                                <button onclick="salvarImpressora()" class="btn-primary w-full">
                                    üíæ Salvar Impressora
                                </button>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Lista de Impressoras -->
                    <div class="lg:col-span-2">
                        <div class="card-section">
                            <h2 class="card-title">üìã Impressoras Cadastradas</h2>
                            <div id="listaImpressoras" class="space-y-3">
                                <!-- Lista via JS -->
                            </div>
                            <div id="semImpressoras" class="text-center py-10 text-gray-500">
                                <div class="text-5xl mb-3">üñ®Ô∏è</div>
                                <p>Nenhuma impressora cadastrada</p>
                                <p class="text-sm">Cadastre sua primeira impressora no formul√°rio ao lado</p>
                            </div>
                        </div>
                    </div>
                    
                </div>
            </div>
            
            <!-- ==================== ABA FILAMENTOS ==================== -->
            <div id="filamentosTab" class="tab-content hidden animate-fade">
                <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
                    
                    <!-- Formul√°rio de Cadastro -->
                    <div class="lg:col-span-1">
                        <div class="card-section sticky top-4">
                            <h2 class="card-title" id="tituloFormFilamento">‚ûï Cadastrar Filamento</h2>
                            <div class="space-y-4">
                                <input type="hidden" id="editandoFilamentoId" value="">
                                <div class="input-group">
                                    <label class="input-label">Tipo de Filamento</label>
                                    <input type="text" id="tipoFilamento" class="input-field" placeholder="Ex: PLA Branco, PETG Preto, ABS Cinza">
                                </div>
                                <div class="input-group">
                                    <label class="input-label">Custo do Filamento (R$/kg)</label>
                                    <input type="number" id="custoFilamento" class="input-field" placeholder="Ex: 120.00" min="0" step="0.01">
                                </div>
                                <div class="input-group">
                                    <label class="input-label">
                                        Estoque Dispon√≠vel (gramas)
                                        <span class="tooltip ml-1 text-gray-400 cursor-help">
                                            ‚ÑπÔ∏è
                                            <span class="tooltiptext">Quantidade em gramas que voc√™ tem deste filamento (1kg = 1000g)</span>
                                        </span>
                                    </label>
                                    <input type="number" id="estoqueFilamento" class="input-field" placeholder="Ex: 1000 (= 1kg)" min="0" step="1">
                                </div>
                                <div class="input-group">
                                    <label class="input-label">Observa√ß√µes (opcional)</label>
                                    <textarea id="obsFilamento" class="input-field" rows="2" placeholder="Ex: Comprado na loja X, boa qualidade, cor exata..."></textarea>
                                </div>
                                <div class="flex gap-2">
                                    <button onclick="salvarFilamento()" class="btn-primary flex-1" id="btnSalvarFilamento">
                                        üíæ Salvar
                                    </button>
                                    <button onclick="cancelarEdicaoFilamento()" class="bg-gray-300 hover:bg-gray-400 text-gray-700 font-medium py-3 px-4 rounded-md transition hidden" id="btnCancelarFilamento">
                                        ‚úñÔ∏è
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Lista de Filamentos -->
                    <div class="lg:col-span-2">
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                            
                            <!-- Coluna PLA -->
                            <div class="card-section">
                                <h2 class="card-title text-blue-700">üîµ Filamentos PLA</h2>
                                
                                <!-- Resumo de Estoque PLA -->
                                <div class="bg-blue-50 border border-blue-200 rounded-lg p-3 mb-4" id="resumoEstoquePLA">
                                    <div class="flex justify-between items-center text-sm">
                                        <span class="text-blue-700">üì¶ Estoque PLA:</span>
                                        <span class="font-bold text-blue-800" id="totalEstoquePLA">0g</span>
                                    </div>
                                </div>
                                
                                <div id="listaFilamentosPLA" class="space-y-3">
                                    <!-- Lista via JS -->
                                </div>
                                <div id="semFilamentosPLA" class="text-center py-6 text-gray-500">
                                    <div class="text-3xl mb-2">üîµ</div>
                                    <p class="text-sm">Nenhum PLA cadastrado</p>
                                </div>
                            </div>
                            
                            <!-- Coluna PETG -->
                            <div class="card-section">
                                <h2 class="card-title text-orange-700">üü† Filamentos PETG</h2>
                                
                                <!-- Resumo de Estoque PETG -->
                                <div class="bg-orange-50 border border-orange-200 rounded-lg p-3 mb-4" id="resumoEstoquePETG">
                                    <div class="flex justify-between items-center text-sm">
                                        <span class="text-orange-700">üì¶ Estoque PETG:</span>
                                        <span class="font-bold text-orange-800" id="totalEstoquePETG">0g</span>
                                    </div>
                                </div>
                                
                                <div id="listaFilamentosPETG" class="space-y-3">
                                    <!-- Lista via JS -->
                                </div>
                                <div id="semFilamentosPETG" class="text-center py-6 text-gray-500">
                                    <div class="text-3xl mb-2">üü†</div>
                                    <p class="text-sm">Nenhum PETG cadastrado</p>
                                </div>
                            </div>
                            
                        </div>
                        
                        <!-- Outros filamentos (ABS, TPU, etc) -->
                        <div class="card-section mt-4" id="secaoOutrosFilamentos" style="display: none;">
                            <h2 class="card-title text-gray-700">‚ö™ Outros Filamentos</h2>
                            
                            <div class="bg-gray-50 border border-gray-200 rounded-lg p-3 mb-4" id="resumoEstoqueOutros">
                                <div class="flex justify-between items-center text-sm">
                                    <span class="text-gray-700">üì¶ Estoque Outros:</span>
                                    <span class="font-bold text-gray-800" id="totalEstoqueOutros">0g</span>
                                </div>
                            </div>
                            
                            <div id="listaFilamentosOutros" class="grid grid-cols-1 md:grid-cols-2 gap-3">
                                <!-- Lista via JS -->
                            </div>
                        </div>
                    </div>
                    
                </div>
            </div>
            
            <!-- ==================== ABA CONFIGURA√á√ïES ==================== -->
            <div id="configuracoesTab" class="tab-content hidden animate-fade">
                <div class="max-w-2xl mx-auto">
                    <div class="card-section">
                        <h2 class="card-title">‚öôÔ∏è Configura√ß√µes Gerais</h2>
                        <p class="text-gray-600 mb-6">Configure os valores padr√£o que ser√£o usados em todos os or√ßamentos.</p>
                        
                        <div class="space-y-6">
                            
                            <!-- Dados da Empresa -->
                            <div class="bg-indigo-50 border border-indigo-200 rounded-lg p-4">
                                <h3 class="font-semibold text-indigo-800 mb-3">üè¢ Dados da Sua Empresa</h3>
                                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                    <div class="input-group">
                                        <label class="input-label">Nome da Empresa</label>
                                        <input type="text" id="configNomeEmpresa" class="input-field" placeholder="Ex: Cambori√∫ 3D">
                                        <p class="text-xs text-gray-500 mt-1">Aparecer√° no PDF e texto copiado</p>
                                    </div>
                                    <div class="input-group">
                                        <label class="input-label">Contato da Empresa</label>
                                        <input type="text" id="configContatoEmpresa" class="input-field" placeholder="Ex: @instagram ou (47) 99999-9999">
                                        <p class="text-xs text-gray-500 mt-1">WhatsApp, Instagram, telefone, etc.</p>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- Energia -->
                            <div class="bg-yellow-50 border border-yellow-200 rounded-lg p-4">
                                <h3 class="font-semibold text-yellow-800 mb-3">‚ö° Energia El√©trica</h3>
                                <div class="input-group">
                                    <label class="input-label">Pre√ßo do kWh (R$)</label>
                                    <input type="number" id="configPrecoKwh" class="input-field" placeholder="Ex: 0.85" min="0" step="0.01" value="0.85">
                                    <p class="text-xs text-gray-500 mt-1">Consulte sua conta de luz. M√©dia Brasil: R$ 0,70 a R$ 1,00</p>
                                </div>
                            </div>
                            
                            <!-- Manuten√ß√£o -->
                            <div class="bg-orange-50 border border-orange-200 rounded-lg p-4">
                                <h3 class="font-semibold text-orange-800 mb-3">üîß Manuten√ß√£o</h3>
                                <div class="input-group">
                                    <label class="input-label">Custo de Manuten√ß√£o por Hora (R$)</label>
                                    <input type="number" id="configManutencao" class="input-field" placeholder="Ex: 0.50" min="0" step="0.01" value="0.50">
                                    <p class="text-xs text-gray-500 mt-1">Reserva para bicos, correias, rolamentos e outras pe√ßas</p>
                                </div>
                            </div>
                            
                            <!-- M√£o de Obra -->
                            <div class="bg-blue-50 border border-blue-200 rounded-lg p-4">
                                <h3 class="font-semibold text-blue-800 mb-3">üë∑ M√£o de Obra</h3>
                                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                    <div class="input-group">
                                        <label class="input-label">Valor da Sua Hora (R$)</label>
                                        <input type="number" id="configMaoObra" class="input-field" placeholder="Ex: 20.00" min="0" step="0.01" value="20.00">
                                    </div>
                                    <div class="input-group">
                                        <label class="input-label">
                                            Fator de Dedica√ß√£o (%)
                                            <span class="tooltip ml-1 text-gray-400 cursor-help">
                                                ‚ÑπÔ∏è
                                                <span class="tooltiptext">Quanto do tempo de impress√£o voc√™ dedica ativamente (preparar, monitorar, finalizar). Ex: 20% = a cada 1h de impress√£o, voc√™ trabalha 12min.</span>
                                            </span>
                                        </label>
                                        <input type="number" id="configFatorMaoObra" class="input-field" placeholder="Ex: 20" min="0" max="100" value="20">
                                    </div>
                                </div>
                            </div>
                            
                            <button onclick="salvarConfiguracoes()" class="btn-primary w-full">
                                üíæ Salvar Configura√ß√µes
                            </button>
                            
                        </div>
                    </div>
                    
                    <!-- Info Box -->
                    <div class="bg-indigo-50 border border-indigo-200 rounded-lg p-4 mt-6">
                        <h3 class="font-semibold text-indigo-800 mb-2">üí° Como funciona o c√°lculo?</h3>
                        <div class="text-sm text-indigo-700 space-y-2">
                            <p><strong>Custo Total</strong> = Material + Energia + Deprecia√ß√£o + Manuten√ß√£o + M√£o de Obra + Extras</p>
                            <p><strong>Pre√ßo Final</strong> = Custo Total √ó (1 + Markup%)</p>
                            <p class="text-xs text-indigo-600 mt-2">‚ö†Ô∏è Este sistema usa APENAS markup como lucro, sem duplica√ß√£o de margem.</p>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- ==================== ABA HIST√ìRICO ==================== -->
            <div id="historicoTab" class="tab-content hidden animate-fade">
                
                <!-- Sub-abas do Hist√≥rico -->
                <div class="bg-white rounded-lg shadow-md mb-6">
                    <div class="flex">
                        <button class="subtab active flex-1 py-3 px-4 text-center font-medium text-sm border-b-2" data-subtab="pendentes" onclick="mudarSubTab('pendentes')">
                            üìã Or√ßamentos Pendentes
                        </button>
                        <button class="subtab flex-1 py-3 px-4 text-center font-medium text-sm border-b-2 border-transparent" data-subtab="vendidos" onclick="mudarSubTab('vendidos')">
                            ‚úÖ Vendidos
                        </button>
                        <button class="subtab flex-1 py-3 px-4 text-center font-medium text-sm border-b-2 border-transparent" data-subtab="recusados" onclick="mudarSubTab('recusados')">
                            ‚ùå Recusados
                        </button>
                    </div>
                </div>
                
                <!-- Sub-aba: Pendentes -->
                <div id="pendentesSubTab" class="subtab-content">
                    <div class="card-section">
                        <div class="flex flex-col sm:flex-row justify-between items-start sm:items-center gap-4 mb-4">
                            <h2 class="card-title mb-0">üìã Or√ßamentos Pendentes</h2>
                            <button onclick="limparHistorico()" class="bg-red-500 hover:bg-red-600 text-white text-sm font-medium py-2 px-4 rounded-md transition">
                                üóëÔ∏è Limpar Pendentes
                            </button>
                        </div>
                        
                        <div class="overflow-x-auto">
                            <table class="min-w-full divide-y divide-gray-200">
                                <thead>
                                    <tr>
                                        <th class="px-3 py-3 bg-gray-50 text-left text-xs font-medium text-gray-500 uppercase">Pe√ßa</th>
                                        <th class="px-3 py-3 bg-gray-50 text-left text-xs font-medium text-gray-500 uppercase">Cliente</th>
                                        <th class="px-3 py-3 bg-gray-50 text-left text-xs font-medium text-gray-500 uppercase">Filamento</th>
                                        <th class="px-3 py-3 bg-gray-50 text-left text-xs font-medium text-gray-500 uppercase">Custo</th>
                                        <th class="px-3 py-3 bg-gray-50 text-left text-xs font-medium text-gray-500 uppercase">Pre√ßo</th>
                                        <th class="px-3 py-3 bg-gray-50 text-left text-xs font-medium text-gray-500 uppercase">Data</th>
                                        <th class="px-3 py-3 bg-gray-50 text-left text-xs font-medium text-gray-500 uppercase">Status</th>
                                        <th class="px-3 py-3 bg-gray-50 text-left text-xs font-medium text-gray-500 uppercase">A√ß√µes</th>
                                    </tr>
                                </thead>
                                <tbody id="tabelaHistorico" class="bg-white divide-y divide-gray-200">
                                </tbody>
                            </table>
                        </div>
                        
                        <div id="semHistorico" class="text-center py-10 text-gray-500">
                            <div class="text-5xl mb-3">üìã</div>
                            <p>Nenhum or√ßamento pendente</p>
                            <p class="text-sm">Seus or√ßamentos salvos aparecer√£o aqui</p>
                        </div>
                    </div>
                </div>
                
                <!-- Sub-aba: Vendidos -->
                <div id="vendidosSubTab" class="subtab-content hidden">
                    <div class="card-section">
                        <div class="flex flex-col sm:flex-row justify-between items-start sm:items-center gap-4 mb-4">
                            <h2 class="card-title mb-0">‚úÖ Vendas Realizadas</h2>
                            <div class="flex gap-2 items-center">
                                <select id="filtroMesVendas" class="input-field text-sm py-2" onchange="carregarVendidos()">
                                    <option value="">Todos os meses</option>
                                </select>
                            </div>
                        </div>
                        
                        <!-- Resumo de Vendas -->
                        <div class="grid grid-cols-2 md:grid-cols-5 gap-3 mb-6">
                            <div class="bg-green-50 border border-green-200 rounded-lg p-3 text-center">
                                <p class="text-green-600 text-xs">Total Vendido</p>
                                <p class="text-xl font-bold text-green-700" id="totalVendido">R$ 0,00</p>
                            </div>
                            <div class="bg-blue-50 border border-blue-200 rounded-lg p-3 text-center">
                                <p class="text-blue-600 text-xs">Lucro Total</p>
                                <p class="text-xl font-bold text-blue-700" id="lucroTotalVendas">R$ 0,00</p>
                            </div>
                            <div class="bg-purple-50 border border-purple-200 rounded-lg p-3 text-center">
                                <p class="text-purple-600 text-xs">Qtd. Vendas</p>
                                <p class="text-xl font-bold text-purple-700" id="qtdVendas">0</p>
                            </div>
                            <div class="bg-sky-50 border border-sky-200 rounded-lg p-3 text-center">
                                <p class="text-sky-600 text-xs">üîµ PLA Usado</p>
                                <p class="text-xl font-bold text-sky-700" id="totalPLAVendido">0g</p>
                            </div>
                            <div class="bg-orange-50 border border-orange-200 rounded-lg p-3 text-center">
                                <p class="text-orange-600 text-xs">üü† PETG Usado</p>
                                <p class="text-xl font-bold text-orange-700" id="totalPETGVendido">0g</p>
                            </div>
                        </div>
                        
                        <div class="overflow-x-auto">
                            <table class="min-w-full divide-y divide-gray-200">
                                <thead>
                                    <tr>
                                        <th class="px-3 py-3 bg-gray-50 text-left text-xs font-medium text-gray-500 uppercase">Pe√ßa</th>
                                        <th class="px-3 py-3 bg-gray-50 text-left text-xs font-medium text-gray-500 uppercase">Cliente</th>
                                        <th class="px-3 py-3 bg-gray-50 text-left text-xs font-medium text-gray-500 uppercase">Filamento</th>
                                        <th class="px-3 py-3 bg-gray-50 text-left text-xs font-medium text-gray-500 uppercase">Custo</th>
                                        <th class="px-3 py-3 bg-gray-50 text-left text-xs font-medium text-gray-500 uppercase">Vendido</th>
                                        <th class="px-3 py-3 bg-gray-50 text-left text-xs font-medium text-gray-500 uppercase">Lucro</th>
                                        <th class="px-3 py-3 bg-gray-50 text-left text-xs font-medium text-gray-500 uppercase">Data</th>
                                        <th class="px-3 py-3 bg-gray-50 text-left text-xs font-medium text-gray-500 uppercase">A√ß√µes</th>
                                    </tr>
                                </thead>
                                <tbody id="tabelaVendidos" class="bg-white divide-y divide-gray-200">
                                </tbody>
                            </table>
                        </div>
                        
                        <div id="semVendidos" class="text-center py-10 text-gray-500">
                            <div class="text-5xl mb-3">‚úÖ</div>
                            <p>Nenhuma venda registrada</p>
                            <p class="text-sm">Marque or√ßamentos como "Vendido" para aparecerem aqui</p>
                        </div>
                    </div>
                </div>
                
                <!-- Sub-aba: Recusados -->
                <div id="recusadosSubTab" class="subtab-content hidden">
                    <div class="card-section">
                        <div class="flex flex-col sm:flex-row justify-between items-start sm:items-center gap-4 mb-4">
                            <h2 class="card-title mb-0">‚ùå Or√ßamentos Recusados</h2>
                            <button onclick="limparRecusados()" class="bg-red-500 hover:bg-red-600 text-white text-sm font-medium py-2 px-4 rounded-md transition">
                                üóëÔ∏è Limpar Recusados
                            </button>
                        </div>
                        
                        <div class="overflow-x-auto">
                            <table class="min-w-full divide-y divide-gray-200">
                                <thead>
                                    <tr>
                                        <th class="px-3 py-3 bg-gray-50 text-left text-xs font-medium text-gray-500 uppercase">Pe√ßa</th>
                                        <th class="px-3 py-3 bg-gray-50 text-left text-xs font-medium text-gray-500 uppercase">Cliente</th>
                                        <th class="px-3 py-3 bg-gray-50 text-left text-xs font-medium text-gray-500 uppercase">Pre√ßo</th>
                                        <th class="px-3 py-3 bg-gray-50 text-left text-xs font-medium text-gray-500 uppercase">Data</th>
                                        <th class="px-3 py-3 bg-gray-50 text-left text-xs font-medium text-gray-500 uppercase">A√ß√µes</th>
                                    </tr>
                                </thead>
                                <tbody id="tabelaRecusados" class="bg-white divide-y divide-gray-200">
                                </tbody>
                            </table>
                        </div>
                        
                        <div id="semRecusados" class="text-center py-10 text-gray-500">
                            <div class="text-5xl mb-3">‚ùå</div>
                            <p>Nenhum or√ßamento recusado</p>
                        </div>
                    </div>
                </div>
                
            </div>
            
        </div>
    </div>
    
    <!-- Modal PDF -->
    <div id="pdfModal" class="fixed inset-0 bg-black bg-opacity-50 hidden flex items-center justify-center z-50">
        <div class="bg-white rounded-lg shadow-xl max-w-2xl w-full max-h-[90vh] overflow-y-auto m-4">
            <div class="p-4 border-b flex justify-between items-center sticky top-0 bg-white">
                <h3 class="text-lg font-medium text-gray-900">üìÑ Pr√©via do Or√ßamento</h3>
                <button onclick="fecharModal()" class="text-gray-500 hover:text-gray-700 text-2xl">&times;</button>
            </div>
            <div id="pdfContent" class="p-6">
                <!-- Conte√∫do do PDF -->
            </div>
            <div class="p-4 border-t flex gap-2 justify-end sticky bottom-0 bg-white">
                <button onclick="fecharModal()" class="bg-gray-200 hover:bg-gray-300 text-gray-700 font-medium py-2 px-4 rounded-md">
                    Cancelar
                </button>
                <button onclick="gerarPDF()" class="btn-primary">
                    üì• Baixar PDF
                </button>
            </div>
        </div>
    </div>
    
    <!-- Toast -->
    <div id="toast" class="fixed bottom-4 right-4 bg-gray-800 text-white px-6 py-3 rounded-lg shadow-lg transform translate-y-20 opacity-0 transition-all duration-300 z-50">
        <span id="toastMsg"></span>
    </div>
    
    <!-- Footer -->
    <footer class="bg-gray-900 text-gray-300 mt-10">
        <div class="max-w-7xl mx-auto px-6 py-10">
            <div class="grid md:grid-cols-4 gap-8 text-center md:text-left">
                
                <div>
                    <h3 class="text-white font-semibold text-xl mb-3">Cambori√∫ 3D</h3>
                    <p class="text-sm text-gray-400">
                        Solu√ß√µes em impress√£o 3D e c√°lculo profissional de custos para produ√ß√£o.
                    </p>
                </div>

                <div>
                    <h3 class="text-white font-semibold text-lg mb-3">Contato</h3>
                    <p class="text-sm mb-2">
                        üìß <a href="/cdn-cgi/l/email-protection#c9aaa6a7bda8bda689aaa8a4aba6bba0bcfaade7aaa6a4e7abbb" class="hover:text-white"><span class="__cf_email__" data-cfemail="ea8985849e8b9e85aa898b87888598839fd98ec4898587c48898">[email&#160;protected]</span></a>
                    </p>
                    <p class="text-sm">
                        üì∏ <a href="https://instagram.com/camboriu3d" target="_blank" class="hover:text-white">@camboriu3d</a>
                    </p>
                </div>

                <div>
                    <h3 class="text-white font-semibold text-lg mb-3">Informa√ß√µes</h3>
                    <p class="text-sm mb-2">
                        <a href="sobre.html" class="hover:text-white">Sobre</a>
                    </p>
                    <p class="text-sm mb-2">
                        <a href="politica.html" class="hover:text-white">Pol√≠tica de Privacidade</a>
                    </p>
                    <p class="text-sm">
                        <a href="termos.html" class="hover:text-white">Termos de Uso</a>
                    </p>
                </div>
                
                <div>
                    <h3 class="text-white font-semibold text-lg mb-3">Sistema</h3>
                    <p class="text-sm text-gray-400">
                        C√°lculo com markup √∫nico.<br>
                        Sem duplica√ß√£o de lucro.<br>
                        Pre√ßos justos e competitivos.
                    </p>
                </div>

            </div>

            <div class="border-t border-gray-700 mt-8 pt-6 text-center text-sm text-gray-500">
                ¬© 2025 Cambori√∫ 3D ‚Äî Todos os direitos reservados.
            </div>
        </div>
    </footer>

    <script data-cfasync="false" src="/cdn-cgi/scripts/5c5dd728/cloudflare-static/email-decode.min.js"></script><script>
        // ==================== VARI√ÅVEIS GLOBAIS ====================
        let impressoraSelecionada = null;
        let filamentoSelecionado = null;
        let ultimoOrcamento = null;
        
        // ==================== INICIALIZA√á√ÉO ====================
        document.addEventListener('DOMContentLoaded', function() {
            carregarConfiguracoes();
            carregarImpressoras();
            carregarFilamentos();
            atualizarSelectImpressoras();
            atualizarSelectFilamentos();
            carregarHistorico();
        });
        
        // ==================== TABS ====================
        function mudarTab(tabId) {
            // Esconder todas as abas
            document.querySelectorAll('.tab-content').forEach(tab => tab.classList.add('hidden'));
            // Remover active de todos os bot√µes
            document.querySelectorAll('.tab').forEach(btn => btn.classList.remove('active'));
            
            // Mostrar aba selecionada
            document.getElementById(tabId + 'Tab').classList.remove('hidden');
            // Ativar bot√£o
            document.querySelector(`[data-tab="${tabId}"]`).classList.add('active');
            
            // Atualizar lista se necess√°rio
            if (tabId === 'calculadora') {
                atualizarSelectImpressoras();
                atualizarSelectFilamentos();
            }
            if (tabId === 'historico') carregarHistorico();
        }
        
        // ==================== TOAST ====================
        function toast(msg, duration = 3000) {
            const t = document.getElementById('toast');
            document.getElementById('toastMsg').textContent = msg;
            t.classList.remove('translate-y-20', 'opacity-0');
            setTimeout(() => t.classList.add('translate-y-20', 'opacity-0'), duration);
        }
        
        // ==================== FORMATA√á√ÉO ====================
        function formatarMoeda(valor) {
            return 'R$ ' + valor.toFixed(2).replace('.', ',');
        }
        
        function parseNum(val) {
            return parseFloat(val) || 0;
        }
        
        // ==================== CONFIGURA√á√ïES ====================
        function getConfig() {
            return JSON.parse(localStorage.getItem('config3d')) || {
                precoKwh: 0.85,
                manutencaoHora: 0.50,
                maoObraHora: 20.00,
                fatorMaoObra: 20,
                nomeEmpresa: 'Minha Empresa 3D',
                contatoEmpresa: '@minhaempresa'
            };
        }
        
        function carregarConfiguracoes() {
            const c = getConfig();
            document.getElementById('configPrecoKwh').value = c.precoKwh;
            document.getElementById('configManutencao').value = c.manutencaoHora;
            document.getElementById('configMaoObra').value = c.maoObraHora;
            document.getElementById('configFatorMaoObra').value = c.fatorMaoObra;
            document.getElementById('configNomeEmpresa').value = c.nomeEmpresa || '';
            document.getElementById('configContatoEmpresa').value = c.contatoEmpresa || '';
        }
        
        function salvarConfiguracoes() {
            const config = {
                precoKwh: parseNum(document.getElementById('configPrecoKwh').value),
                manutencaoHora: parseNum(document.getElementById('configManutencao').value),
                maoObraHora: parseNum(document.getElementById('configMaoObra').value),
                fatorMaoObra: parseNum(document.getElementById('configFatorMaoObra').value),
                nomeEmpresa: document.getElementById('configNomeEmpresa').value || 'Minha Empresa 3D',
                contatoEmpresa: document.getElementById('configContatoEmpresa').value || ''
            };
            localStorage.setItem('config3d', JSON.stringify(config));
            toast('‚úÖ Configura√ß√µes salvas!');
            calcular();
        }
        
        // ==================== IMPRESSORAS ====================
        function getImpressoras() {
            return JSON.parse(localStorage.getItem('impressoras3d')) || [];
        }
        
        function salvarImpressoras(lista) {
            localStorage.setItem('impressoras3d', JSON.stringify(lista));
        }
        
        function salvarImpressora() {
            const nome = document.getElementById('nomeImpressora').value.trim();
            const valor = parseNum(document.getElementById('valorImpressora').value);
            const vidaUtil = parseInt(document.getElementById('vidaUtilImpressora').value) || 0;
            const potencia = parseInt(document.getElementById('potenciaImpressora').value) || 0;
            
            if (!nome) { toast('‚ùå Informe o nome'); return; }
            if (valor <= 0) { toast('‚ùå Informe o valor'); return; }
            if (vidaUtil <= 0) { toast('‚ùå Informe a vida √∫til'); return; }
            if (potencia <= 0) { toast('‚ùå Informe a pot√™ncia'); return; }
            
            const impressoras = getImpressoras();
            impressoras.push({
                id: Date.now(),
                nome,
                valor,
                vidaUtil,
                potencia,
                custoHora: valor / vidaUtil
            });
            
            salvarImpressoras(impressoras);
            
            // Limpar
            document.getElementById('nomeImpressora').value = '';
            document.getElementById('valorImpressora').value = '';
            document.getElementById('vidaUtilImpressora').value = '5000';
            document.getElementById('potenciaImpressora').value = '';
            
            carregarImpressoras();
            atualizarSelectImpressoras();
            toast('‚úÖ Impressora cadastrada!');
        }
        
        function excluirImpressora(id) {
            if (!confirm('Excluir esta impressora?')) return;
            let lista = getImpressoras().filter(p => p.id !== id);
            salvarImpressoras(lista);
            carregarImpressoras();
            atualizarSelectImpressoras();
            toast('üóëÔ∏è Impressora exclu√≠da');
        }
        
        function carregarImpressoras() {
            const lista = getImpressoras();
            const container = document.getElementById('listaImpressoras');
            const semMsg = document.getElementById('semImpressoras');
            
            if (lista.length === 0) {
                container.innerHTML = '';
                semMsg.style.display = 'block';
                return;
            }
            
            semMsg.style.display = 'none';
            container.innerHTML = lista.map(p => `
                <div class="bg-gray-50 border border-gray-200 rounded-lg p-4 flex justify-between items-start">
                    <div>
                        <h3 class="font-semibold text-gray-800">${p.nome}</h3>
                        <div class="text-sm text-gray-600 mt-1 space-y-1">
                            <p>üí∞ Valor: ${formatarMoeda(p.valor)}</p>
                            <p>‚è∞ Vida √∫til: ${p.vidaUtil.toLocaleString()}h</p>
                            <p>‚ö° Pot√™ncia: ${p.potencia}W</p>
                            <p class="text-indigo-600 font-medium">üìä Custo/hora: ${formatarMoeda(p.custoHora)}</p>
                        </div>
                    </div>
                    <button onclick="excluirImpressora(${p.id})" class="text-red-500 hover:text-red-700 text-xl">üóëÔ∏è</button>
                </div>
            `).join('');
        }
        
        function atualizarSelectImpressoras() {
            const lista = getImpressoras();
            const container = document.getElementById('impressoraSelect');
            const semMsg = document.getElementById('semImpressoraMsg');
            
            if (lista.length === 0) {
                container.innerHTML = '';
                semMsg.classList.remove('hidden');
                impressoraSelecionada = null;
                return;
            }
            
            semMsg.classList.add('hidden');
            container.innerHTML = lista.map((p, i) => `
                <div class="printer-option ${i === 0 ? 'selected' : ''}" data-id="${p.id}" onclick="selecionarImpressora(${p.id})">
                    <h4 class="font-semibold text-gray-800">${p.nome}</h4>
                    <p class="text-xs text-gray-500">${p.potencia}W ‚Ä¢ ${formatarMoeda(p.custoHora)}/h</p>
                </div>
            `).join('');
            
            // Selecionar primeira
            impressoraSelecionada = lista[0];
            calcular();
        }
        
        function selecionarImpressora(id) {
            const lista = getImpressoras();
            impressoraSelecionada = lista.find(p => p.id === id);
            
            document.querySelectorAll('.printer-option').forEach(el => {
                el.classList.remove('selected');
                if (parseInt(el.dataset.id) === id) el.classList.add('selected');
            });
            
            calcular();
        }
        
        // ==================== FILAMENTOS ====================
        function getFilamentos() {
            return JSON.parse(localStorage.getItem('filamentos3d')) || [];
        }
        
        function salvarFilamentos(lista) {
            localStorage.setItem('filamentos3d', JSON.stringify(lista));
        }
        
        function salvarFilamento() {
            const editandoId = document.getElementById('editandoFilamentoId').value;
            const tipo = document.getElementById('tipoFilamento').value.trim();
            const custo = parseNum(document.getElementById('custoFilamento').value);
            const estoque = parseNum(document.getElementById('estoqueFilamento').value);
            const obs = document.getElementById('obsFilamento').value.trim();
            
            if (!tipo) { toast('‚ùå Informe o tipo do filamento'); return; }
            if (custo <= 0) { toast('‚ùå Informe o custo do filamento'); return; }
            
            let filamentos = getFilamentos();
            
            if (editandoId) {
                // Editando
                const index = filamentos.findIndex(f => f.id === parseInt(editandoId));
                if (index !== -1) {
                    filamentos[index] = { ...filamentos[index], tipo, custo, estoque, obs };
                }
                toast('‚úÖ Filamento atualizado!');
            } else {
                // Novo
                filamentos.push({
                    id: Date.now(),
                    tipo,
                    custo,
                    estoque,
                    obs
                });
                toast('‚úÖ Filamento cadastrado!');
            }
            
            salvarFilamentos(filamentos);
            cancelarEdicaoFilamento();
            carregarFilamentos();
            atualizarSelectFilamentos();
        }
        
        function editarFilamento(id) {
            const filamentos = getFilamentos();
            const f = filamentos.find(fil => fil.id === id);
            if (!f) return;
            
            document.getElementById('editandoFilamentoId').value = id;
            document.getElementById('tipoFilamento').value = f.tipo;
            document.getElementById('custoFilamento').value = f.custo;
            document.getElementById('estoqueFilamento').value = f.estoque || '';
            document.getElementById('obsFilamento').value = f.obs || '';
            
            document.getElementById('tituloFormFilamento').textContent = '‚úèÔ∏è Editando Filamento';
            document.getElementById('btnSalvarFilamento').textContent = 'üíæ Atualizar';
            document.getElementById('btnCancelarFilamento').classList.remove('hidden');
        }
        
        function cancelarEdicaoFilamento() {
            document.getElementById('editandoFilamentoId').value = '';
            document.getElementById('tipoFilamento').value = '';
            document.getElementById('custoFilamento').value = '';
            document.getElementById('estoqueFilamento').value = '';
            document.getElementById('obsFilamento').value = '';
            
            document.getElementById('tituloFormFilamento').textContent = '‚ûï Cadastrar Filamento';
            document.getElementById('btnSalvarFilamento').textContent = 'üíæ Salvar';
            document.getElementById('btnCancelarFilamento').classList.add('hidden');
        }
        
        function excluirFilamento(id) {
            if (!confirm('Excluir este filamento?')) return;
            let lista = getFilamentos().filter(f => f.id !== id);
            salvarFilamentos(lista);
            carregarFilamentos();
            atualizarSelectFilamentos();
            toast('üóëÔ∏è Filamento exclu√≠do');
        }
        
        function carregarFilamentos() {
            const lista = getFilamentos();
            
            // Separar por tipo
            const filamentosPLA = lista.filter(f => f.tipo.toUpperCase().includes('PLA'));
            const filamentosPETG = lista.filter(f => f.tipo.toUpperCase().includes('PETG'));
            const filamentosOutros = lista.filter(f => 
                !f.tipo.toUpperCase().includes('PLA') && 
                !f.tipo.toUpperCase().includes('PETG')
            );
            
            // Calcular totais de estoque
            const totalPLA = filamentosPLA.reduce((sum, f) => sum + (f.estoque || 0), 0);
            const totalPETG = filamentosPETG.reduce((sum, f) => sum + (f.estoque || 0), 0);
            const totalOutros = filamentosOutros.reduce((sum, f) => sum + (f.estoque || 0), 0);
            
            document.getElementById('totalEstoquePLA').textContent = totalPLA.toLocaleString() + 'g (' + (totalPLA / 1000).toFixed(2) + ' kg)';
            document.getElementById('totalEstoquePETG').textContent = totalPETG.toLocaleString() + 'g (' + (totalPETG / 1000).toFixed(2) + ' kg)';
            document.getElementById('totalEstoqueOutros').textContent = totalOutros.toLocaleString() + 'g (' + (totalOutros / 1000).toFixed(2) + ' kg)';
            
            // Renderizar PLA
            const containerPLA = document.getElementById('listaFilamentosPLA');
            const semPLA = document.getElementById('semFilamentosPLA');
            if (filamentosPLA.length === 0) {
                containerPLA.innerHTML = '';
                semPLA.style.display = 'block';
            } else {
                semPLA.style.display = 'none';
                containerPLA.innerHTML = filamentosPLA.map(f => renderizarFilamento(f, 'blue')).join('');
            }
            
            // Renderizar PETG
            const containerPETG = document.getElementById('listaFilamentosPETG');
            const semPETG = document.getElementById('semFilamentosPETG');
            if (filamentosPETG.length === 0) {
                containerPETG.innerHTML = '';
                semPETG.style.display = 'block';
            } else {
                semPETG.style.display = 'none';
                containerPETG.innerHTML = filamentosPETG.map(f => renderizarFilamento(f, 'orange')).join('');
            }
            
            // Renderizar Outros
            const containerOutros = document.getElementById('listaFilamentosOutros');
            const secaoOutros = document.getElementById('secaoOutrosFilamentos');
            if (filamentosOutros.length === 0) {
                secaoOutros.style.display = 'none';
            } else {
                secaoOutros.style.display = 'block';
                containerOutros.innerHTML = filamentosOutros.map(f => renderizarFilamento(f, 'gray')).join('');
            }
        }
        
        function renderizarFilamento(f, cor) {
            const cores = {
                blue: { bg: 'bg-blue-50', border: 'border-blue-200', text: 'text-blue-600' },
                orange: { bg: 'bg-orange-50', border: 'border-orange-200', text: 'text-orange-600' },
                gray: { bg: 'bg-gray-50', border: 'border-gray-200', text: 'text-gray-600' }
            };
            const c = cores[cor] || cores.gray;
            
            return `
                <div class="${c.bg} border ${c.border} rounded-lg p-3">
                    <div class="flex justify-between items-start">
                        <div class="flex-1">
                            <h3 class="font-semibold text-gray-800 text-sm">${f.tipo}</h3>
                            <div class="text-xs text-gray-600 mt-1 flex flex-wrap gap-2">
                                <span class="${c.text} font-medium">üí∞ ${formatarMoeda(f.custo)}/kg</span>
                                <span class="${(f.estoque || 0) < 100 ? 'text-red-500' : 'text-green-600'} font-medium">
                                    üì¶ ${(f.estoque || 0).toLocaleString()}g
                                </span>
                            </div>
                            ${f.obs ? `<p class="text-gray-500 text-xs mt-2 bg-white p-2 rounded">üìù ${f.obs}</p>` : ''}
                        </div>
                        <div class="flex gap-1 ml-2">
                            <button onclick="editarFilamento(${f.id})" class="text-blue-500 hover:text-blue-700 text-sm p-1">‚úèÔ∏è</button>
                            <button onclick="excluirFilamento(${f.id})" class="text-red-500 hover:text-red-700 text-sm p-1">üóëÔ∏è</button>
                        </div>
                    </div>
                </div>
            `;
        }
        
        function atualizarSelectFilamentos() {
            const lista = getFilamentos();
            const select = document.getElementById('filamentoSelect');
            const semMsg = document.getElementById('semFilamentoMsg');
            
            if (lista.length === 0) {
                select.innerHTML = '<option value="">Nenhum filamento cadastrado</option>';
                semMsg.classList.remove('hidden');
                filamentoSelecionado = null;
                return;
            }
            
            // Separar por tipo
            const filamentosPLA = lista.filter(f => f.tipo.toUpperCase().includes('PLA'));
            const filamentosPETG = lista.filter(f => f.tipo.toUpperCase().includes('PETG'));
            const filamentosOutros = lista.filter(f => 
                !f.tipo.toUpperCase().includes('PLA') && 
                !f.tipo.toUpperCase().includes('PETG')
            );
            
            semMsg.classList.add('hidden');
            
            let options = '<option value="">Selecione um filamento</option>';
            
            if (filamentosPLA.length > 0) {
                options += '<optgroup label="üîµ PLA">';
                options += filamentosPLA.map(f => {
                    const estoque = f.estoque || 0;
                    const estoqueInfo = estoque < 100 ? '‚ö†Ô∏è' : '‚úÖ';
                    return `<option value="${f.id}">${f.tipo} - ${formatarMoeda(f.custo)}/kg ${estoqueInfo} ${estoque.toLocaleString()}g</option>`;
                }).join('');
                options += '</optgroup>';
            }
            
            if (filamentosPETG.length > 0) {
                options += '<optgroup label="üü† PETG">';
                options += filamentosPETG.map(f => {
                    const estoque = f.estoque || 0;
                    const estoqueInfo = estoque < 100 ? '‚ö†Ô∏è' : '‚úÖ';
                    return `<option value="${f.id}">${f.tipo} - ${formatarMoeda(f.custo)}/kg ${estoqueInfo} ${estoque.toLocaleString()}g</option>`;
                }).join('');
                options += '</optgroup>';
            }
            
            if (filamentosOutros.length > 0) {
                options += '<optgroup label="‚ö™ Outros">';
                options += filamentosOutros.map(f => {
                    const estoque = f.estoque || 0;
                    const estoqueInfo = estoque < 100 ? '‚ö†Ô∏è' : '‚úÖ';
                    return `<option value="${f.id}">${f.tipo} - ${formatarMoeda(f.custo)}/kg ${estoqueInfo} ${estoque.toLocaleString()}g</option>`;
                }).join('');
                options += '</optgroup>';
            }
            
            select.innerHTML = options;
            
            // Selecionar primeiro automaticamente
            if (lista.length > 0 && !filamentoSelecionado) {
                select.value = lista[0].id;
                filamentoSelecionado = lista[0];
            }
            calcular();
        }
        
        function selecionarFilamento() {
            const lista = getFilamentos();
            const select = document.getElementById('filamentoSelect');
            const id = parseInt(select.value);
            
            if (id) {
                filamentoSelecionado = lista.find(f => f.id === id);
            } else {
                filamentoSelecionado = null;
            }
            
            calcular();
        }
        
        // ==================== C√ÅLCULO PRINCIPAL ====================
        function calcular() {
            const config = getConfig();
            
            if (!impressoraSelecionada) {
                zerarResultados();
                return;
            }
            
            // Inputs
            const peso = parseNum(document.getElementById('pesoPeca').value);
            const precoFilamento = filamentoSelecionado ? filamentoSelecionado.custo : 0;
            const horas = parseInt(document.getElementById('tempoHoras').value) || 0;
            const minutos = parseInt(document.getElementById('tempoMinutos').value) || 0;
            const pintura = parseNum(document.getElementById('valorPintura').value);
            const outros = parseNum(document.getElementById('outrosCustos').value);
            const markup = parseNum(document.getElementById('markup').value);
            
            const tempoTotal = horas + (minutos / 60);
            
            // ========== C√ÅLCULOS ==========
            // 1. Material: peso (g) √ó pre√ßo/g
            const custoMaterial = peso * (precoFilamento / 1000);
            
            // 2. Energia: pot√™ncia √ó tempo √ó pre√ßo kWh / 1000
            const custoEnergia = (impressoraSelecionada.potencia * tempoTotal * config.precoKwh) / 1000;
            
            // 3. Deprecia√ß√£o: custo/hora da impressora √ó tempo
            const custoDepreciacao = impressoraSelecionada.custoHora * tempoTotal;
            
            // 4. Manuten√ß√£o: custo/hora √ó tempo
            const custoManutencao = config.manutencaoHora * tempoTotal;
            
            // 5. M√£o de obra: valor/hora √ó tempo √ó fator dedica√ß√£o
            const custoMaoObra = config.maoObraHora * tempoTotal * (config.fatorMaoObra / 100);
            
            // 6 e 7. Extras
            const custoPintura = pintura;
            const custoOutros = outros;
            
            // CUSTO TOTAL
            const custoTotal = custoMaterial + custoEnergia + custoDepreciacao + custoManutencao + custoMaoObra + custoPintura + custoOutros;
            
            // MARKUP (√∫nico lugar onde entra o lucro)
            const valorLucro = custoTotal * (markup / 100);
            const precoFinal = custoTotal + valorLucro;
            
            // ========== ATUALIZAR UI ==========
            document.getElementById('custoMaterial').textContent = formatarMoeda(custoMaterial);
            document.getElementById('custoEnergia').textContent = formatarMoeda(custoEnergia);
            document.getElementById('custoDepreciacao').textContent = formatarMoeda(custoDepreciacao);
            document.getElementById('custoManutencao').textContent = formatarMoeda(custoManutencao);
            document.getElementById('custoMaoObra').textContent = formatarMoeda(custoMaoObra);
            document.getElementById('custoPintura').textContent = formatarMoeda(custoPintura);
            document.getElementById('custoOutros').textContent = formatarMoeda(custoOutros);
            document.getElementById('custoTotal').textContent = formatarMoeda(custoTotal);
            document.getElementById('valorLucro').textContent = formatarMoeda(valorLucro);
            document.getElementById('precoFinal').textContent = formatarMoeda(precoFinal);
            
            // Mostrar/ocultar extras
            document.getElementById('rowPintura').style.display = custoPintura > 0 ? 'flex' : 'none';
            document.getElementById('rowOutros').style.display = custoOutros > 0 ? 'flex' : 'none';
            
            // Salvar para uso posterior
            ultimoOrcamento = {
                nomePeca: document.getElementById('nomePeca').value || 'Sem nome',
                cliente: document.getElementById('clientePeca').value || '-',
                impressora: impressoraSelecionada.nome,
                filamento: filamentoSelecionado ? filamentoSelecionado.tipo : '-',
                filamentoId: filamentoSelecionado ? filamentoSelecionado.id : null,
                peso, precoFilamento, horas, minutos, tempoTotal,
                custoMaterial, custoEnergia, custoDepreciacao, custoManutencao, custoMaoObra,
                custoPintura, custoOutros, custoTotal, markup, valorLucro, precoFinal,
                data: new Date().toLocaleDateString('pt-BR'),
                dataHora: new Date().toLocaleString('pt-BR')
            };
        }
        
        function zerarResultados() {
            ['custoMaterial', 'custoEnergia', 'custoDepreciacao', 'custoManutencao', 'custoMaoObra', 
             'custoPintura', 'custoOutros', 'custoTotal', 'valorLucro', 'precoFinal'].forEach(id => {
                document.getElementById(id).textContent = 'R$ 0,00';
            });
        }
        
        function limparFormulario() {
            document.getElementById('nomePeca').value = '';
            document.getElementById('clientePeca').value = '';
            document.getElementById('pesoPeca').value = '';
            document.getElementById('filamentoSelect').selectedIndex = 0;
            filamentoSelecionado = null;
            document.getElementById('tempoHoras').value = '';
            document.getElementById('tempoMinutos').value = '';
            document.getElementById('valorPintura').value = '';
            document.getElementById('outrosCustos').value = '';
            document.getElementById('markup').value = '50';
            calcular();
            toast('üîÑ Formul√°rio limpo');
        }
        
        // ==================== SALVAR OR√áAMENTO ====================
        function salvarOrcamento() {
            if (!ultimoOrcamento || ultimoOrcamento.precoFinal <= 0) {
                toast('‚ùå Preencha os dados primeiro');
                return;
            }
            
            // Atualizar nome e cliente com valores atuais do formul√°rio
            ultimoOrcamento.nomePeca = document.getElementById('nomePeca').value || 'Sem nome';
            ultimoOrcamento.cliente = document.getElementById('clientePeca').value || '-';
            ultimoOrcamento.dataHora = new Date().toLocaleString('pt-BR');
            ultimoOrcamento.data = new Date().toLocaleDateString('pt-BR');
            
            let historico = JSON.parse(localStorage.getItem('historico3d')) || [];
            historico.unshift({ ...ultimoOrcamento, id: Date.now() });
            if (historico.length > 100) historico.pop();
            localStorage.setItem('historico3d', JSON.stringify(historico));
            
            toast('‚úÖ Or√ßamento salvo!');
            carregarHistorico();
        }
        
        function copiarOrcamento() {
            if (!ultimoOrcamento || ultimoOrcamento.precoFinal <= 0) {
                toast('‚ùå Preencha os dados primeiro');
                return;
            }
            
            // Atualizar nome e cliente com valores atuais do formul√°rio
            ultimoOrcamento.nomePeca = document.getElementById('nomePeca').value || 'Sem nome';
            ultimoOrcamento.cliente = document.getElementById('clientePeca').value || '-';
            ultimoOrcamento.dataHora = new Date().toLocaleString('pt-BR');
            
            const config = getConfig();
            const o = ultimoOrcamento;
            
            let txt = `üì¶ *OR√áAMENTO IMPRESS√ÉO 3D*\n`;
            txt += `üè¢ ${config.nomeEmpresa}\n`;
            txt += `‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ\n\n`;
            txt += `üìÖ Data: ${o.dataHora}\n`;
            if (o.nomePeca !== 'Sem nome') txt += `üìã Pe√ßa: ${o.nomePeca}\n`;
            if (o.cliente !== '-') txt += `üë§ Cliente: ${o.cliente}\n`;
            txt += `\nüìê *Especifica√ß√µes:*\n`;
            if (o.filamento && o.filamento !== '-') txt += `‚Ä¢ Material: ${o.filamento}\n`;
            txt += `‚Ä¢ Peso: ${o.peso}g\n`;
            txt += `‚Ä¢ Tempo de produ√ß√£o: ${o.horas}h ${o.minutos}min\n`;
            txt += `\n‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ\n`;
            txt += `üí∞ *VALOR: ${formatarMoeda(o.precoFinal)}*\n`;
            txt += `‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ\n\n`;
            txt += `‚úÖ Or√ßamento v√°lido por 7 dias\n`;
            if (config.contatoEmpresa) txt += `üì± ${config.contatoEmpresa}`;
            
            navigator.clipboard.writeText(txt).then(() => toast('üìã Copiado!'));
        }
        
        // ==================== HIST√ìRICO ====================
        function mudarSubTab(subtabId) {
            document.querySelectorAll('.subtab-content').forEach(c => c.classList.add('hidden'));
            document.querySelectorAll('.subtab').forEach(b => {
                b.classList.remove('active');
                b.classList.add('border-transparent');
            });
            
            document.getElementById(subtabId + 'SubTab').classList.remove('hidden');
            document.querySelector(`[data-subtab="${subtabId}"]`).classList.add('active');
            document.querySelector(`[data-subtab="${subtabId}"]`).classList.remove('border-transparent');
            
            if (subtabId === 'vendidos') carregarVendidos();
            if (subtabId === 'recusados') carregarRecusados();
        }
        
        function carregarHistorico() {
            const historico = JSON.parse(localStorage.getItem('historico3d')) || [];
            const tabela = document.getElementById('tabelaHistorico');
            const semMsg = document.getElementById('semHistorico');
            
            if (historico.length === 0) {
                tabela.innerHTML = '';
                semMsg.style.display = 'block';
                return;
            }
            
            semMsg.style.display = 'none';
            tabela.innerHTML = historico.map(o => `
                <tr>
                    <td class="px-3 py-3 text-sm">${o.nomePeca}</td>
                    <td class="px-3 py-3 text-sm">${o.cliente}</td>
                    <td class="px-3 py-3 text-sm text-xs">${o.filamento || '-'}</td>
                    <td class="px-3 py-3 text-sm">${formatarMoeda(o.custoTotal)}</td>
                    <td class="px-3 py-3 text-sm font-semibold text-indigo-600">${formatarMoeda(o.precoFinal)}</td>
                    <td class="px-3 py-3 text-sm text-gray-500">${o.data}</td>
                    <td class="px-3 py-3 text-sm">
                        <button onclick="marcarVendido(${o.id})" class="bg-green-100 hover:bg-green-200 text-green-700 text-xs px-2 py-1 rounded mr-1" title="Marcar como Vendido">‚úÖ</button>
                        <button onclick="marcarRecusado(${o.id})" class="bg-red-100 hover:bg-red-200 text-red-700 text-xs px-2 py-1 rounded" title="Marcar como Recusado">‚ùå</button>
                    </td>
                    <td class="px-3 py-3 text-sm">
                        <button onclick="carregarOrcamentoHistorico(${o.id})" class="text-indigo-600 hover:underline mr-1" title="Editar">üìù</button>
                        <button onclick="excluirOrcamento(${o.id})" class="text-red-500 hover:underline" title="Excluir">üóëÔ∏è</button>
                    </td>
                </tr>
            `).join('');
        }
        
        function marcarVendido(id) {
            let historico = JSON.parse(localStorage.getItem('historico3d')) || [];
            const orcamento = historico.find(o => o.id === id);
            if (!orcamento) return;
            
            // Descontar peso do estoque do filamento
            if (orcamento.filamentoId && orcamento.peso > 0) {
                let filamentos = getFilamentos();
                const filamentoIndex = filamentos.findIndex(f => f.id === orcamento.filamentoId);
                if (filamentoIndex !== -1) {
                    filamentos[filamentoIndex].estoque = Math.max(0, (filamentos[filamentoIndex].estoque || 0) - orcamento.peso);
                    salvarFilamentos(filamentos);
                    carregarFilamentos();
                }
            }
            
            // Remover do hist√≥rico pendente
            historico = historico.filter(o => o.id !== id);
            localStorage.setItem('historico3d', JSON.stringify(historico));
            
            // Adicionar aos vendidos
            let vendidos = JSON.parse(localStorage.getItem('vendidos3d')) || [];
            orcamento.dataVenda = new Date().toLocaleDateString('pt-BR');
            orcamento.mesVenda = new Date().toISOString().slice(0, 7); // YYYY-MM
            vendidos.unshift(orcamento);
            localStorage.setItem('vendidos3d', JSON.stringify(vendidos));
            
            toast('‚úÖ Vendido! Estoque atualizado');
            carregarHistorico();
            atualizarFiltroMeses();
        }
        
        function marcarRecusado(id) {
            let historico = JSON.parse(localStorage.getItem('historico3d')) || [];
            const orcamento = historico.find(o => o.id === id);
            if (!orcamento) return;
            
            // Remover do hist√≥rico pendente
            historico = historico.filter(o => o.id !== id);
            localStorage.setItem('historico3d', JSON.stringify(historico));
            
            // Adicionar aos recusados
            let recusados = JSON.parse(localStorage.getItem('recusados3d')) || [];
            orcamento.dataRecusa = new Date().toLocaleDateString('pt-BR');
            recusados.unshift(orcamento);
            localStorage.setItem('recusados3d', JSON.stringify(recusados));
            
            toast('‚ùå Marcado como recusado');
            carregarHistorico();
        }
        
        function atualizarFiltroMeses() {
            const vendidos = JSON.parse(localStorage.getItem('vendidos3d')) || [];
            const select = document.getElementById('filtroMesVendas');
            const mesesUnicos = [...new Set(vendidos.map(v => v.mesVenda))].sort().reverse();
            
            select.innerHTML = '<option value="">Todos os meses</option>' +
                mesesUnicos.map(m => {
                    const [ano, mes] = m.split('-');
                    const nomeMes = new Date(ano, mes - 1).toLocaleString('pt-BR', { month: 'long', year: 'numeric' });
                    return `<option value="${m}">${nomeMes}</option>`;
                }).join('');
        }
        
        function carregarVendidos() {
            const vendidos = JSON.parse(localStorage.getItem('vendidos3d')) || [];
            const filtroMes = document.getElementById('filtroMesVendas').value;
            const tabela = document.getElementById('tabelaVendidos');
            const semMsg = document.getElementById('semVendidos');
            
            atualizarFiltroMeses();
            
            let vendidosFiltrados = filtroMes 
                ? vendidos.filter(v => v.mesVenda === filtroMes)
                : vendidos;
            
            // Calcular totais
            const totalVendido = vendidosFiltrados.reduce((sum, v) => sum + v.precoFinal, 0);
            const lucroTotal = vendidosFiltrados.reduce((sum, v) => sum + v.valorLucro, 0);
            const qtdVendas = vendidosFiltrados.length;
            
            // Calcular totais de PLA e PETG usados
            const totalPLA = vendidosFiltrados
                .filter(v => v.filamento && v.filamento.toUpperCase().includes('PLA'))
                .reduce((sum, v) => sum + (v.peso || 0), 0);
            
            const totalPETG = vendidosFiltrados
                .filter(v => v.filamento && v.filamento.toUpperCase().includes('PETG'))
                .reduce((sum, v) => sum + (v.peso || 0), 0);
            
            document.getElementById('totalVendido').textContent = formatarMoeda(totalVendido);
            document.getElementById('lucroTotalVendas').textContent = formatarMoeda(lucroTotal);
            document.getElementById('qtdVendas').textContent = qtdVendas;
            document.getElementById('totalPLAVendido').textContent = totalPLA.toLocaleString() + 'g';
            document.getElementById('totalPETGVendido').textContent = totalPETG.toLocaleString() + 'g';
            
            if (vendidosFiltrados.length === 0) {
                tabela.innerHTML = '';
                semMsg.style.display = 'block';
                return;
            }
            
            semMsg.style.display = 'none';
            tabela.innerHTML = vendidosFiltrados.map(o => `
                <tr class="bg-green-50">
                    <td class="px-3 py-3 text-sm">${o.nomePeca}</td>
                    <td class="px-3 py-3 text-sm">${o.cliente}</td>
                    <td class="px-3 py-3 text-sm text-xs">${o.filamento || '-'}</td>
                    <td class="px-3 py-3 text-sm">${formatarMoeda(o.custoTotal)}</td>
                    <td class="px-3 py-3 text-sm font-semibold text-green-600">${formatarMoeda(o.precoFinal)}</td>
                    <td class="px-3 py-3 text-sm font-medium text-blue-600">${formatarMoeda(o.valorLucro)}</td>
                    <td class="px-3 py-3 text-sm text-gray-500">${o.dataVenda || o.data}</td>
                    <td class="px-3 py-3 text-sm">
                        <button onclick="desfazerVenda(${o.id})" class="text-orange-500 hover:underline mr-1" title="Voltar para Pendentes">‚Ü©Ô∏è</button>
                        <button onclick="excluirVendido(${o.id})" class="text-red-500 hover:underline" title="Excluir">üóëÔ∏è</button>
                    </td>
                </tr>
            `).join('');
        }
        
        function carregarRecusados() {
            const recusados = JSON.parse(localStorage.getItem('recusados3d')) || [];
            const tabela = document.getElementById('tabelaRecusados');
            const semMsg = document.getElementById('semRecusados');
            
            if (recusados.length === 0) {
                tabela.innerHTML = '';
                semMsg.style.display = 'block';
                return;
            }
            
            semMsg.style.display = 'none';
            tabela.innerHTML = recusados.map(o => `
                <tr class="bg-red-50">
                    <td class="px-3 py-3 text-sm">${o.nomePeca}</td>
                    <td class="px-3 py-3 text-sm">${o.cliente}</td>
                    <td class="px-3 py-3 text-sm font-semibold">${formatarMoeda(o.precoFinal)}</td>
                    <td class="px-3 py-3 text-sm text-gray-500">${o.dataRecusa || o.data}</td>
                    <td class="px-3 py-3 text-sm">
                        <button onclick="desfazerRecusa(${o.id})" class="text-orange-500 hover:underline mr-1" title="Voltar para Pendentes">‚Ü©Ô∏è</button>
                        <button onclick="excluirRecusado(${o.id})" class="text-red-500 hover:underline" title="Excluir">üóëÔ∏è</button>
                    </td>
                </tr>
            `).join('');
        }
        
        function desfazerVenda(id) {
            let vendidos = JSON.parse(localStorage.getItem('vendidos3d')) || [];
            const orcamento = vendidos.find(v => v.id === id);
            if (!orcamento) return;
            
            // Devolver peso ao estoque do filamento
            if (orcamento.filamentoId && orcamento.peso > 0) {
                let filamentos = getFilamentos();
                const filamentoIndex = filamentos.findIndex(f => f.id === orcamento.filamentoId);
                if (filamentoIndex !== -1) {
                    filamentos[filamentoIndex].estoque = (filamentos[filamentoIndex].estoque || 0) + orcamento.peso;
                    salvarFilamentos(filamentos);
                    carregarFilamentos();
                }
            }
            
            vendidos = vendidos.filter(v => v.id !== id);
            localStorage.setItem('vendidos3d', JSON.stringify(vendidos));
            
            let historico = JSON.parse(localStorage.getItem('historico3d')) || [];
            delete orcamento.dataVenda;
            delete orcamento.mesVenda;
            historico.unshift(orcamento);
            localStorage.setItem('historico3d', JSON.stringify(historico));
            
            toast('‚Ü©Ô∏è Voltou para pendentes. Estoque restaurado');
            carregarVendidos();
            carregarHistorico();
        }
        
        function desfazerRecusa(id) {
            let recusados = JSON.parse(localStorage.getItem('recusados3d')) || [];
            const orcamento = recusados.find(r => r.id === id);
            if (!orcamento) return;
            
            recusados = recusados.filter(r => r.id !== id);
            localStorage.setItem('recusados3d', JSON.stringify(recusados));
            
            let historico = JSON.parse(localStorage.getItem('historico3d')) || [];
            delete orcamento.dataRecusa;
            historico.unshift(orcamento);
            localStorage.setItem('historico3d', JSON.stringify(historico));
            
            toast('‚Ü©Ô∏è Voltou para pendentes');
            carregarRecusados();
            carregarHistorico();
        }
        
        function excluirVendido(id) {
            if (!confirm('Excluir esta venda do hist√≥rico?')) return;
            let vendidos = JSON.parse(localStorage.getItem('vendidos3d')) || [];
            vendidos = vendidos.filter(v => v.id !== id);
            localStorage.setItem('vendidos3d', JSON.stringify(vendidos));
            carregarVendidos();
            toast('üóëÔ∏è Venda exclu√≠da');
        }
        
        function excluirRecusado(id) {
            if (!confirm('Excluir este or√ßamento recusado?')) return;
            let recusados = JSON.parse(localStorage.getItem('recusados3d')) || [];
            recusados = recusados.filter(r => r.id !== id);
            localStorage.setItem('recusados3d', JSON.stringify(recusados));
            carregarRecusados();
            toast('üóëÔ∏è Recusado exclu√≠do');
        }
        
        function carregarOrcamentoHistorico(id) {
            const historico = JSON.parse(localStorage.getItem('historico3d')) || [];
            const o = historico.find(h => h.id === id);
            if (!o) return;
            
            document.getElementById('nomePeca').value = o.nomePeca !== 'Sem nome' ? o.nomePeca : '';
            document.getElementById('clientePeca').value = o.cliente !== '-' ? o.cliente : '';
            document.getElementById('pesoPeca').value = o.peso;
            
            // Tentar selecionar o filamento pelo ID salvo
            if (o.filamentoId) {
                const select = document.getElementById('filamentoSelect');
                select.value = o.filamentoId;
                const filamentos = getFilamentos();
                filamentoSelecionado = filamentos.find(f => f.id === o.filamentoId) || null;
            }
            
            document.getElementById('tempoHoras').value = o.horas;
            document.getElementById('tempoMinutos').value = o.minutos;
            document.getElementById('valorPintura').value = o.custoPintura || '';
            document.getElementById('outrosCustos').value = o.custoOutros || '';
            document.getElementById('markup').value = o.markup;
            
            mudarTab('calculadora');
            calcular();
            toast('üìù Or√ßamento carregado');
        }
        
        function excluirOrcamento(id) {
            if (!confirm('Excluir este or√ßamento?')) return;
            let historico = JSON.parse(localStorage.getItem('historico3d')) || [];
            historico = historico.filter(o => o.id !== id);
            localStorage.setItem('historico3d', JSON.stringify(historico));
            carregarHistorico();
            toast('üóëÔ∏è Or√ßamento exclu√≠do');
        }
        
        function limparHistorico() {
            if (!confirm('Limpar todos os or√ßamentos PENDENTES?\n\n(Vendidos e Recusados n√£o ser√£o afetados)')) return;
            localStorage.removeItem('historico3d');
            carregarHistorico();
            toast('üóëÔ∏è Pendentes limpos');
        }
        
        function limparRecusados() {
            if (!confirm('Limpar todos os or√ßamentos RECUSADOS?')) return;
            localStorage.removeItem('recusados3d');
            carregarRecusados();
            toast('üóëÔ∏è Recusados limpos');
        }
        
        // ==================== EXPORTAR PDF ====================
        function exportarPDF() {
            if (!ultimoOrcamento || ultimoOrcamento.precoFinal <= 0) {
                toast('‚ùå Preencha os dados primeiro');
                return;
            }
            
            // Atualizar nome e cliente com valores atuais do formul√°rio
            ultimoOrcamento.nomePeca = document.getElementById('nomePeca').value || 'Sem nome';
            ultimoOrcamento.cliente = document.getElementById('clientePeca').value || '-';
            ultimoOrcamento.dataHora = new Date().toLocaleString('pt-BR');
            
            const config = getConfig();
            const o = ultimoOrcamento;
            
            document.getElementById('pdfContent').innerHTML = `
                <div class="text-center mb-8">
                    <h1 class="text-3xl font-bold text-indigo-700 mb-2">${config.nomeEmpresa}</h1>
                    <p class="text-gray-500 text-sm">Or√ßamento de Impress√£o 3D</p>
                </div>
                
                <div class="bg-gray-50 rounded-lg p-6 mb-6">
                    <div class="grid grid-cols-2 gap-6">
                        <div>
                            <p class="text-gray-500 text-sm mb-1">Cliente</p>
                            <p class="font-semibold text-gray-800 text-lg">${o.cliente}</p>
                        </div>
                        <div>
                            <p class="text-gray-500 text-sm mb-1">Data</p>
                            <p class="font-semibold text-gray-800 text-lg">${o.dataHora}</p>
                        </div>
                    </div>
                </div>
                
                <div class="bg-white border border-gray-200 rounded-lg p-6 mb-6">
                    <h2 class="font-semibold text-gray-800 text-lg mb-4 pb-2 border-b">üì¶ Detalhes do Projeto</h2>
                    <div class="space-y-3">
                        <div class="flex justify-between">
                            <span class="text-gray-600">Pe√ßa:</span>
                            <span class="font-medium text-gray-800">${o.nomePeca}</span>
                        </div>
                        ${o.filamento && o.filamento !== '-' ? `
                        <div class="flex justify-between">
                            <span class="text-gray-600">Material:</span>
                            <span class="font-medium text-gray-800">${o.filamento}</span>
                        </div>
                        ` : ''}
                        <div class="flex justify-between">
                            <span class="text-gray-600">Peso:</span>
                            <span class="font-medium text-gray-800">${o.peso}g</span>
                        </div>
                        <div class="flex justify-between">
                            <span class="text-gray-600">Tempo de produ√ß√£o:</span>
                            <span class="font-medium text-gray-800">${o.horas}h ${o.minutos}min</span>
                        </div>
                    </div>
                </div>
                
                <div class="bg-gradient-to-r from-indigo-500 to-purple-600 rounded-lg p-6 mb-6 text-white">
                    <div class="text-center">
                        <p class="text-indigo-100 text-sm mb-2">Valor Total</p>
                        <p class="text-4xl font-bold">${formatarMoeda(o.precoFinal)}</p>
                    </div>
                </div>
                
                <div class="text-center text-gray-500 text-sm space-y-1 mt-8 pt-4 border-t">
                    <p>‚úÖ Or√ßamento v√°lido por 7 dias</p>
                    <p>üì± ${config.contatoEmpresa || config.nomeEmpresa}</p>
                </div>
            `;
            
            document.getElementById('pdfModal').classList.remove('hidden');
        }
        
        function fecharModal() {
            document.getElementById('pdfModal').classList.add('hidden');
        }
        
        function gerarPDF() {
            const { jsPDF } = window.jspdf;
            const content = document.getElementById('pdfContent');
            
            html2canvas(content, { scale: 2 }).then(canvas => {
                const imgData = canvas.toDataURL('image/png');
                const pdf = new jsPDF('p', 'mm', 'a4');
                const imgWidth = 190;
                const imgHeight = (canvas.height * imgWidth) / canvas.width;
                
                pdf.addImage(imgData, 'PNG', 10, 10, imgWidth, imgHeight);
                
                const config = getConfig();
                const nomeArquivo = ultimoOrcamento.nomePeca !== 'Sem nome' 
                    ? `orcamento-${ultimoOrcamento.nomePeca.replace(/\s+/g, '-')}.pdf`
                    : `orcamento-${config.nomeEmpresa.replace(/\s+/g, '-')}.pdf`;
                
                pdf.save(nomeArquivo);
                fecharModal();
                toast('üì• PDF gerado!');
            });
        }
    </script>
</body>
</html>